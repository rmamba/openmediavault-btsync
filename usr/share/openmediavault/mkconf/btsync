#!/bin/sh
#
# Copyright (C) 2013-2014 OpenMediaVault Plugin Developers
#
# This file is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# any later version.
#
# This file is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this file. If not, see <http://www.gnu.org/licenses/>.

set -e

. /etc/default/openmediavault
. /usr/share/openmediavault/scripts/helper-functions

OMV_BTSYNC_API_KEY=/var/lib/openmediavault/openmediavault-btsync.key
OMV_BTSYNC_CONF=/etc/btsync/openmediavault.conf
OMV_BTSYNC_USER=btsync

OMV_BTSYNC_PLUGIN_XPATH=//services/btsync

device_name=$(omv_config_get "${OMV_BTSYNC_PLUGIN_XPATH}/device_name")
listening_port=$(omv_config_get "${OMV_BTSYNC_PLUGIN_XPATH}/listening_port")
use_upnp=$(omv_config_get "${OMV_BTSYNC_PLUGIN_XPATH}/use_upnp")
lan_use_tcp=$(omv_config_get "${OMV_BTSYNC_PLUGIN_XPATH}/lan_use_tcp")
download_limit=$(omv_config_get "${OMV_BTSYNC_PLUGIN_XPATH}/download_limit")
upload_limit=$(omv_config_get "${OMV_BTSYNC_PLUGIN_XPATH}/upload_limit")

webui_enable=$(omv_config_get "${OMV_BTSYNC_PLUGIN_XPATH}/webui_enable")
webui_port=$(omv_config_get "${OMV_BTSYNC_PLUGIN_XPATH}/webui_port")
webui_username=$(omv_config_get "${OMV_BTSYNC_PLUGIN_XPATH}/webui_username")
webui_password=$(omv_config_get "${OMV_BTSYNC_PLUGIN_XPATH}/webui_password")

if [ "${use_upnp}" -eq "1" ]; then
    use_upnp=true
else
    use_upnp=false
fi

if [ "${lan_use_tcp}" -eq "1" ]; then
    lan_use_tcp=true
else
    lan_use_tcp=false
fi

if [ "${webui_enable}" -eq "1" ]; then
    host="0.0.0.0"
else
    host="127.0.0.1"
fi

# Get the API key
while read -r line; do
    if [ "$(echo $line | cut -c1)" != "#" ]; then
        api_key=$line
        break
    fi
done < ${OMV_BTSYNC_API_KEY}

cat <<EOF > ${OMV_BTSYNC_CONF}
// Configuration generated by OpenMediaVault
// DAEMON_UID=${OMV_BTSYNC_USER}
// DAEMON_GID=${OMV_BTSYNC_USER}
{
    "device_name": "${device_name}",
    "listening_port": ${listening_port},
    "storage_path": "/home/${OMV_BTSYNC_USER}/.sync",
    "check_for_updates": false,
    "use_upnp": ${use_upnp},
    "lan_use_tcp": ${lan_use_tcp},
    "download_limit": ${download_limit},
    "upload_limit": ${upload_limit},
    "use_gui": false,
    "webui": {
        "listen": "$host:$webui_port",
        "login": "$webui_username",
        "password": "$webui_password",
        // This key belongs to OpenMediaVault Plugin Developers.
        // If you want to build your own application, please do not use this key.
        // Instead request a key at http://www.bittorrent.com/sync/developers
        "api_key": "$api_key"
    }
}
EOF

exit 0
